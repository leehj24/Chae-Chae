<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì±„ì±„</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=6" />
</head>
<body>
  {% set state = session.get('state', 'ì§€ì—­') %}

  <header class="topbar">
    <div class="topbar-inner">
      <a class="home-btn" href="{{ url_for('home') }}" aria-label="í™ˆí˜ì´ì§€ë¡œ ê°€ê¸°">ğŸ  í™ˆí˜ì´ì§€</a>
      <a class="logo" href="{{ url_for('home') }}">
        <span class="dot"></span><strong>ì±„ì±„</strong>
      </a>
      <div class="topbar-actions">
        {% if session.get('messages', [])|length > 1 %}
          <a class="home-btn ghost" href="{{ url_for('go_back') }}">ë’¤ë¡œ ê°€ê¸°</a>
        {% endif %}
        <a class="home-btn" href="{{ url_for('reset_chat') }}">ìƒˆë¡œ ì‹œì‘</a>
      </div>
    </div>
  </header>

  <main class="chat-page">
    <div class="chat-container">
      <section id="chat-window" class="chat-window" data-state="{{ state }}">
        {% for msg in session.get('messages', []) %}
          <div class="msg {{ 'user' if msg.sender == 'user' else 'bot' }}">
            <div class="bubble">
              {% if msg.html %}{{ msg.html|safe }}{% else %}{{ msg.text }}{% endif %}
            </div>
          </div>
        {% endfor %}

        {% if state == 'ì™„ë£Œ' and session.get('itinerary') %}
          {% set itin = session.get('itinerary', []) %}
          {% set groups = (itin|groupby('day'))|list %}
          {% set cat_icons = {'ìì—°':'ğŸŒ³','ë ˆí¬ì¸ ':'ğŸƒ','ì‡¼í•‘':'ğŸ›ï¸','ìŒì‹':'ğŸ½ï¸','ì¸ë¬¸(ë¬¸í™”/ì˜ˆìˆ /ì—­ì‚¬)':'ğŸ›ï¸'} %}
          <div class="day-stack">
            {% for day, rows in groups %}
              {% set rows = rows|list %}
              {% set day_label = (rows[0].get('day_label') or (day ~ 'ì¼ì°¨')) %}
              <section class="day-card" data-day="{{ day }}">
                <header class="day-card-header"><div class="day-chip">{{ day_label }}</div></header>
                <ol class="timeline">
                  {% for r in rows %}
                    {% set is_move = (r.title == 'ì´ë™') %}
                    <li class="tl-item {{ 'move' if is_move else 'visit' }}"
                        {% if not is_move %}
                          data-title="{{ r.title }}"
                          data-addr1="{{ r.addr1 }}"
                        {% endif %}>
                      <div class="tl-content-wrapper">
                        <div class="tl-text-content">
                          <div class="tl-time">{{ r.start_time }} â€“ {{ r.end_time }}</div>
                          {% if not is_move %}
                            <h4 class="tl-title"><span class="ico">{{ cat_icons.get(r.cat1, 'ğŸ“') }}</span>{{ r.title }}</h4>
                            <div class="addr">{{ r.addr1 }}</div>
                            <div class="tags">
                              {% if r.cat1 %}<span class="chip">{{ r.cat1 }}</span>{% endif %}
                              {% if r.cat3 %}<span class="chip ghost">{{ r.cat3 }}</span>{% endif %}
                            </div>
                          {% else %}
                            <h4 class="tl-title">ğŸš‡ ì´ë™</h4>
                            <div class="move-details">
                              {% if r.êµí†µí¸1 or r.êµí†µí¸2 %}
                                <span class="chip ghost small">{{ r.êµí†µí¸1 }}</span>
                                <span class="chip ghost small">{{ r.êµí†µí¸2 }}</span>
                              {% else %}
                                <span>{{ r.ì¶œë°œì§€ }} â†’ {{ r.ë„ì°©ì§€ }}</span>
                              {% endif %}
                            </div>
                          {% endif %}
                        </div>
                        {% if not is_move %}
                        <div class="tl-media-content">
                          <div class="media-carousel-container"><div class="media-loading"><div class="spinner small"></div></div></div>
                          <div class="kakao-map-container"><div class="media-loading"><div class="spinner small"></div></div></div>
                        </div>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ol>
              </section>
            {% endfor %}
          </div>
        {% endif %}
      </section>

      <div class="input-area">
        {% if state == 'ì§€ì—­' %}
          <form class="input-bar" method="post" action="{{ url_for('chat') }}">
            <input class="chat-input" type="text" name="region" placeholder="ì˜ˆ) ì„œìš¸, ë¶€ì‚°, ì œì£¼â€¦" required autofocus />
            <button class="send-btn" type="submit" aria-label="ë³´ë‚´ê¸°">
              <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
            </button>
          </form>
        {% elif state == 'ì ìˆ˜' %}
          <div class="button-wrap">
            <button type="button" class="score-btn theme-btn" data-value="ê´€ê´‘ì§€ìˆ˜"><span class="icon">ğŸ—ºï¸</span><span class="label">ê´€ê´‘ì§€ìˆ˜</span></button>
            <button type="button" class="score-btn theme-btn" data-value="ì¸ê¸°ë„ì§€ìˆ˜"><span class="icon">ğŸ”¥</span><span class="label">ì¸ê¸°ë„ì§€ìˆ˜</span></button>
          </div>
          <form id="scoreForm" method="post" action="{{ url_for('chat') }}"><input type="hidden" name="score" id="scoreInput" /></form>
        {% elif state == 'í…Œë§ˆ' %}
          {% set themes = [{'v': 'ìì—°', 'l': 'ìì—°', 'i': 'ğŸŒ³'}, {'v': 'ë ˆí¬ì¸ ', 'l': 'ë ˆí¬ì¸ ', 'i': 'ğŸƒ'}, {'v': 'ì‡¼í•‘', 'l': 'ì‡¼í•‘', 'i': 'ğŸ›ï¸'}, {'v': 'ìŒì‹', 'l': 'ìŒì‹', 'i': 'ğŸ½ï¸'}, {'v': 'ì¸ë¬¸(ë¬¸í™”/ì˜ˆìˆ /ì—­ì‚¬)', 'l': 'ë¬¸í™”', 'i': 'ğŸ­'}] %}
          <div class="button-wrap wide">
            {% for t in themes %}
              <button type="button" class="theme-btn" data-value="{{ t.v }}"><span class="icon">{{ t.i }}</span><span class="label">{{ t.l }}</span></button>
            {% endfor %}
          </div>
          <div class="theme-actions">
            <button id="themeClear" type="button" class="ghost-btn small">ì´ˆê¸°í™”</button>
            <button id="themeSubmit" type="button" class="primary-btn small" disabled>ì„ íƒ ì™„ë£Œ (0/3)</button>
          </div>
          <form id="themeForm" method="post" action="{{ url_for('chat') }}"><input type="hidden" name="themes" id="themesInput" /></form>
        {% elif state == 'ê¸°ê°„' %}
          <form id="rangeForm" class="range-form" method="post" action="{{ url_for('chat') }}">
            <div class="date-row">
              <div class="date-box"><label for="startDate">ì‹œì‘</label><div class="date-field"><input id="startDate" name="start_date" type="date" /><button id="openStart" type="button">ğŸ“…</button></div></div>
              <span class="date-tilde">~</span>
              <div class="date-box"><label for="endDate">ì¢…ë£Œ</label><div class="date-field"><input id="endDate" name="end_date" type="date" /><button id="openEnd" type="button">ğŸ“…</button></div></div>
            </div>
            <div class="range-actions">
              <div class="days-pill">ì´ <span id="daysPreview">â€”</span></div>
              <button id="rangeSubmit" type="submit" class="primary-btn small" disabled>í™•ì¸</button>
            </div>
          </form>
        {% elif state == 'ì´ë™ìˆ˜ë‹¨' %}
          <div class="button-wrap">
            <button type="button" class="transport-btn theme-btn" data-value="walk"><span class="icon">ğŸš¶</span><span class="label">ê±·ê¸°</span></button>
            <button type="button" class="transport-btn theme-btn" data-value="transit"><span class="icon">ğŸš‹</span><span class="label">ëŒ€ì¤‘êµí†µ</span></button>
          </div>
          <form id="transportForm" method="post" action="{{ url_for('chat') }}"><input type="hidden" name="transport" id="transportInput" /></form>
        {% endif %}
      </div>
    </div>
  </main>

  <script src="{{ url_for('static', filename='js/app.js') }}?v=3"></script>
  
  {% if kakao_js_key %}
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services"></script>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chatWindow = document.getElementById('chat-window');
      if (chatWindow.dataset.state !== 'ì™„ë£Œ' || window.resultsRendererInitialized) return;
      window.resultsRendererInitialized = true;
      const DATA_CACHE = new Map();

      const formatStation = (line, station) => {
          if (!station) return '';
          if (line && station.includes(line)) return station;
          return line ? `${line} ${station}`.trim() : station;
      };

      window.handleImgError = function(e) {
        const img = e.target, slide = img.closest('.carousel-slide'), carousel = img.closest('.carousel');
        if (!carousel || !slide) return;
        slide.remove();
        const slides = carousel.querySelectorAll('.carousel-slide');
        if (slides.length === 0) {
          const container = carousel.closest('.media-carousel-container');
          if (container) container.innerHTML = '<div class="no-image-placeholder">ì´ë¯¸ì§€ ì—†ìŒ</div>';
          return;
        }
        carousel.dataset.count = slides.length;
        updateCarouselState(carousel, 0);
      };
      
      async function fetchPlaceData(title, addr) {
        const key = `${title}|${addr}`;
        if (DATA_CACHE.has(key)) return DATA_CACHE.get(key);
        try {
          const [imgRes, geoRes] = await Promise.all([
            fetch(`/api/places?title=${encodeURIComponent(title)}&addr1=${encodeURIComponent(addr)}`),
            fetch(`/api/geocode?title=${encodeURIComponent(title)}&addr=${encodeURIComponent(addr)}`)
          ]);
          const imgData = await imgRes.json(), geoData = await geoRes.json();
          const images = (imgData.ok && imgData.items[0]) ? imgData.items[0].images : [];
          const coords = geoData.ok ? geoData.result : null;
          const result = { images, coords };
          DATA_CACHE.set(key, result);
          return result;
        } catch (error) { return { images: [], coords: null }; }
      }

      function updateCarouselState(carousel, newIndex) {
          const track = carousel.querySelector('.slides-track'), dots = carousel.querySelectorAll('.dots .dot');
          const prevBtn = carousel.querySelector('.cbtn.prev'), nextBtn = carousel.querySelector('.cbtn.next');
          const count = parseInt(carousel.dataset.count, 10) || 0;
          if (count === 0 || !track) return;
          const index = Math.max(0, Math.min(newIndex, count - 1));
          carousel.dataset.slide = index;
          track.style.transform = `translateX(-${index * 100}%)`;
          dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
          if (prevBtn) prevBtn.hidden = (index <= 0);
          if (nextBtn) nextBtn.hidden = (index >= count - 1);
      }

      function setupCarousel(container, images) {
          if (!images || images.length === 0) { container.innerHTML = '<div class="no-image-placeholder">ì´ë¯¸ì§€ ì—†ìŒ</div>'; return; }
          const count = images.length;
          const slidesHtml = images.map(src => `<div class="carousel-slide"><img src="/img-proxy?u=${encodeURIComponent(src)}" alt="ì¥ì†Œ ì‚¬ì§„" loading="lazy" referrerpolicy="no-referrer" onerror="handleImgError(event)"></div>`).join('');
          const dotsHtml = count > 1 ? `<div class="dots">${Array.from({ length: count }, (_, i) => `<button type="button" class="dot" data-i="${i}"></button>`).join('')}</div>` : '';
          const buttonsHtml = count > 1 ? `<button class="cbtn prev" type="button">â€¹</button><button class="cbtn next" type="button">â€º</button>` : '';
          container.innerHTML = `<div class="carousel" data-slide="0" data-count="${count}">${buttonsHtml}<div class="slides-container"><div class="slides-track">${slidesHtml}</div></div>${dotsHtml}</div>`;
          const carousel = container.querySelector('.carousel');
          updateCarouselState(carousel, 0);
          carousel.addEventListener('click', (e) => {
              const target = e.target;
              let currentIndex = parseInt(carousel.dataset.slide || '0', 10);
              if (target.closest('.cbtn.next')) updateCarouselState(carousel, currentIndex + 1);
              else if (target.closest('.cbtn.prev')) updateCarouselState(carousel, currentIndex - 1);
              else if (target.matches('.dot')) updateCarouselState(carousel, parseInt(target.dataset.i, 10));
          });
      }

      function setupMap(container, coords, title) {
          if (!window.kakao || !window.kakao.maps) { container.innerHTML = '<div class="no-map-placeholder">ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨</div>'; return; }
          if (!coords || !coords.y || !coords.x) { container.innerHTML = '<div class="no-map-placeholder">ìœ„ì¹˜ ì •ë³´ ì—†ìŒ</div>'; return; }
          container.innerHTML = '';
          const position = new kakao.maps.LatLng(coords.y, coords.x);
          const map = new kakao.maps.Map(container, { center: position, level: 4 });
          new kakao.maps.Marker({ map: map, position: position });
          setTimeout(() => map.relayout(), 50);
      }
      
      async function updateMoveCardDetails(moveItem) {
          const fromAddr = moveItem.dataset.fromAddr;
          const toAddr = moveItem.dataset.toAddr;
          if (!fromAddr || !toAddr) return;

          const detailsEl = moveItem.querySelector('.move-details');
          if (!detailsEl) return;

          try {
              const [fromRes, toRes] = await Promise.all([
                  fetch(`/api/nearest-transit?addr=${encodeURIComponent(fromAddr)}`),
                  fetch(`/api/nearest-transit?addr=${encodeURIComponent(toAddr)}`)
              ]);
              const fromData = await fromRes.json();
              const toData = await toRes.json();

              if (!fromData.ok || !toData.ok) return;

              const from = fromData.result;
              const to = toData.result;

              let t1 = '', t2 = '';
              let fromStation = '', toStation = '';

              if (from.subway_station && to.subway_station && from.subway_station !== to.subway_station) {
                  fromStation = formatStation(from.subway_line, from.subway_station);
                  toStation = formatStation(to.subway_line, to.subway_station);
                  t1 = `ì§€í•˜ì²  ${fromStation} ìŠ¹ì°¨`;
                  t2 = `${toStation} í•˜ì°¨`;
              } 
              else if (from.bus_station && to.bus_station && from.bus_station !== to.bus_station) {
                  fromStation = from.bus_station;
                  toStation = to.bus_station;
                  t1 = `ë²„ìŠ¤ ${fromStation} ìŠ¹ì°¨`;
                  t2 = `${toStation} í•˜ì°¨`;
              }

              if (t1 && detailsEl) {
                  detailsEl.innerHTML = `
                      <span class="chip ghost small">${t1}</span>
                      <span class="chip ghost small">${t2}</span>
                  `;
              }
          } catch (e) {
              console.error("Failed to fetch live transit details:", e);
          }
      }
      
      async function initializeAllItems() {
          const allItems = document.querySelectorAll('li.tl-item');
          
          // 1. data attribute ì„¤ì •
          const visits = Array.from(document.querySelectorAll('li.tl-item.visit'));
          document.querySelectorAll('li.tl-item.move').forEach((moveNode, i) => {
              if (visits[i] && visits[i+1]) {
                  moveNode.dataset.fromAddr = visits[i].dataset.addr1;
                  moveNode.dataset.toAddr = visits[i+1].dataset.addr1;
              }
          });

          // 2. ëª¨ë“  ì•„ì´í…œ ì´ˆê¸°í™”
          for(const item of allItems) {
            if (item.classList.contains('visit')) {
              const data = await fetchPlaceData(item.dataset.title, item.dataset.addr1);
              if (!data) continue;
              const carouselContainer = item.querySelector('.media-carousel-container');
              const mapContainer = item.querySelector('.kakao-map-container');
              if (carouselContainer) setupCarousel(carouselContainer, data.images);
              if (mapContainer) setupMap(mapContainer, data.coords, item.dataset.title);
            }
            else if (item.classList.contains('move')) {
                const detailsEl = item.querySelector('.move-details');
                const textSpan = detailsEl ? detailsEl.querySelector('span') : null;
                if (textSpan && (textSpan.textContent || '').includes('â†’')) {
                   updateMoveCardDetails(item);
                }
            }
          }
      }

      if (window.kakao && window.kakao.maps) {
          kakao.maps.load(initializeAllItems);
      } else if (document.querySelector('.kakao-map-container')) {
          initializeAllItems();
      }
    });
  </script>
</body>
</html>