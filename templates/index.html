<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì±„ì±„</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=10" />
</head>
<body>
  {% set state = session.get('state', 'ì§€ì—­') %}

  <header class="topbar">
    <div class="topbar-inner">
      <a class="home-btn" href="{{ url_for('home') }}" aria-label="í™ˆí˜ì´ì§€ë¡œ ê°€ê¸°">ğŸ  í™ˆí˜ì´ì§€</a>
      <a class="logo" href="{{ url_for('home') }}">
        <span class="dot"></span><strong>ì±„ì±„</strong>
      </a>
      <div class="topbar-actions">
        {% if session.get('messages', [])|length > 1 %}
          <a class="home-btn ghost" href="{{ url_for('go_back') }}">ë’¤ë¡œ ê°€ê¸°</a>
        {% endif %}
        <a class="home-btn" href="{{ url_for('reset_chat') }}">ìƒˆë¡œ ì‹œì‘</a>
      </div>
    </div>
  </header>

  <main class="chat-page">
    <div class="chat-container">
      <section id="chat-window" class="chat-window" data-state="{{ state }}">
        {% for msg in session.get('messages', []) %}
          <div class="msg {{ 'user' if msg.sender == 'user' else 'bot' }}">
            <div class="bubble">
              {% if msg.html %}{{ msg.html|safe }}{% else %}{{ msg.text }}{% endif %}
            </div>
          </div>
        {% endfor %}

        {% if state == 'ì™„ë£Œ' and session.get('itinerary') %}
          {% set itin = session.get('itinerary', []) %}
          {% set groups = (itin|groupby('day'))|list %}
          {% set cat_icons = {'ìì—°':'ğŸŒ³','ë ˆí¬ì¸ ':'ğŸƒ','ì‡¼í•‘':'ğŸ›ï¸','ìŒì‹':'ğŸ½ï¸','ì¸ë¬¸(ë¬¸í™”/ì˜ˆìˆ /ì—­ì‚¬)':'ğŸ›ï¸'} %}
          <div class="day-stack">
            {% for day, rows in groups %}
              {% set rows = rows|list %}
              {% set day_label = (rows[0].get('day_label') or (day ~ 'ì¼ì°¨')) %}
              <section class="day-card" data-day="{{ day }}">
                <header class="day-card-header"><div class="day-chip">{{ day_label }}</div></header>
                <ol class="timeline">
                  {% for r in rows %}
                    {% set is_move = (r.title == 'ì´ë™') %}
                    <li class="tl-item {{ 'move' if is_move else 'visit' }}"
                        {% if not is_move %}
                          data-title="{{ r.title }}"
                          data-addr1="{{ r.addr1 }}"
                        {% endif %}>
                      <div class="tl-content-wrapper">
                        <div class="tl-text-content">
                          <div class="tl-time">{{ r.start_time }} â€“ {{ r.end_time }}</div>
                          {% if not is_move %}
                            <h4 class="tl-title"><span class="ico">{{ cat_icons.get(r.cat1, 'ğŸ“') }}</span>{{ r.title }}</h4>
                            <div class="addr">{{ r.addr1 }}</div>
                            <div class="tags">
                              {% if r.cat1 %}<span class="chip">{{ r.cat1 }}</span>{% endif %}
                              {% if r.cat3 %}<span class="chip ghost">{{ r.cat3 }}</span>{% endif %}
                            </div>
                            <div class="card-actions">
                              <div class="star-rating-display" role="button" tabindex="0">
                                <div class="stars-outer">
                                  <div class="stars-inner"></div>
                                </div>
                                <span class="rating-info">
                                  <span class="rating-avg">â€¦</span> (<span class="rating-count">â€¦</span>)
                                </span>
                              </div>
                              <button type="button" class="review-btn">í›„ê¸° ë³´ê¸°/ì‘ì„±</button>
                            </div>
                          {% else %}
                            <h4 class="tl-title">ğŸš‡ ì´ë™</h4>
                            <div class="move-details">
                              {% if r.êµí†µí¸1 or r.êµí†µí¸2 %}
                                <span class="chip ghost small">{{ r.êµí†µí¸1 }}</span>
                                <span class="chip ghost small">{{ r.êµí†µí¸2 }}</span>
                              {% else %}
                                <span>{{ r.ì¶œë°œì§€ }} â†’ {{ r.ë„ì°©ì§€ }}</span>
                              {% endif %}
                            </div>
                          {% endif %}
                        </div>
                        {% if not is_move %}
                        <div class="tl-media-content">
                          <div class="media-carousel-container"><div class="media-loading"><div class="spinner small"></div></div></div>
                          <div class="kakao-map-container"><div class="media-loading"><div class="spinner small"></div></div></div>
                        </div>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ol>
              </section>
            {% endfor %}
          </div>
        {% endif %}
      </section>

      <div class="input-area">
        {% if state == 'ì§€ì—­' %}
          <form class="input-bar" method="post" action="{{ url_for('chat') }}">
            <input class="chat-input" type="text" name="region" placeholder="ì˜ˆ) ì„œìš¸, ë¶€ì‚°, ì œì£¼â€¦" required autofocus />
            <button class="send-btn" type="submit" aria-label="ë³´ë‚´ê¸°">
              <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
            </button>
          </form>
        {% elif state == 'ì ìˆ˜' %}
          <div class="button-wrap">
            <button type="button" class="score-btn theme-btn" data-value="ê´€ê´‘ì§€ìˆ˜"><span class="icon">ğŸ—ºï¸</span><span class="label">ê´€ê´‘ì§€ìˆ˜</span></button>
            <button type="button" class="score-btn theme-btn" data-value="ì¸ê¸°ë„ì§€ìˆ˜"><span class="icon">ğŸ”¥</span><span class="label">ì¸ê¸°ë„ì§€ìˆ˜</span></button>
          </div>
          <form id="scoreForm" method="post" action="{{ url_for('chat') }}"><input type="hidden" name="score" id="scoreInput" /></form>
        {% elif state == 'í…Œë§ˆ' %}
          {% set themes = [{'v': 'ìì—°', 'l': 'ìì—°', 'i': 'ğŸŒ³'}, {'v': 'ë ˆí¬ì¸ ', 'l': 'ë ˆí¬ì¸ ', 'i': 'ğŸƒ'}, {'v': 'ì‡¼í•‘', 'l': 'ì‡¼í•‘', 'i': 'ğŸ›ï¸'}, {'v': 'ìŒì‹', 'l': 'ìŒì‹', 'i': 'ğŸ½ï¸'}, {'v': 'ì¸ë¬¸(ë¬¸í™”/ì˜ˆìˆ /ì—­ì‚¬)', 'l': 'ë¬¸í™”', 'i': 'ğŸ­'}] %}
          <div class="button-wrap wide">
            {% for t in themes %}
              <button type="button" class="theme-btn" data-value="{{ t.v }}"><span class="icon">{{ t.i }}</span><span class="label">{{ t.l }}</span></button>
            {% endfor %}
          </div>
          <div class="theme-actions">
            <button id="themeClear" type="button" class="ghost-btn small">ì´ˆê¸°í™”</button>
            <button id="themeSubmit" type="button" class="primary-btn small" disabled>ì„ íƒ ì™„ë£Œ (0/3)</button>
          </div>
          <form id="themeForm" method="post" action="{{ url_for('chat') }}"><input type="hidden" name="themes" id="themesInput" /></form>
        {% elif state == 'ê¸°ê°„' %}
          <form id="rangeForm" class="range-form" method="post" action="{{ url_for('chat') }}">
            <div class="date-row">
              <div class="date-box"><label for="startDate">ì‹œì‘</label><div class="date-field"><input id="startDate" name="start_date" type="date" /><button id="openStart" type="button">ğŸ“…</button></div></div>
              <span class="date-tilde">~</span>
              <div class="date-box"><label for="endDate">ì¢…ë£Œ</label><div class="date-field"><input id="endDate" name="end_date" type="date" /><button id="openEnd" type="button">ğŸ“…</button></div></div>
            </div>
            <div class="range-actions">
              <div class="days-pill">ì´ <span id="daysPreview">â€”</span></div>
              <button id="rangeSubmit" type="submit" class="primary-btn small" disabled>í™•ì¸</button>
            </div>
          </form>
        {% elif state == 'ì´ë™ìˆ˜ë‹¨' %}
          <div class="button-wrap">
            <button type="button" class="transport-btn theme-btn" data-value="walk"><span class="icon">ğŸš¶</span><span class="label">ê±·ê¸°</span></button>
            <button type="button" class="transport-btn theme-btn" data-value="transit"><span class="icon">ğŸš‹</span><span class="label">ëŒ€ì¤‘êµí†µ</span></button>
          </div>
          <form id="transportForm" method="post" action="{{ url_for('chat') }}"><input type="hidden" name="transport" id="transportInput" /></form>
        {% endif %}
      </div>
    </div>
  </main>

  <div id="ratingModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <header class="modal-header">
        <div>
          <h3 id="modalTitle">ë³„ì  ë‚¨ê¸°ê¸°</h3>
          <span id="modalPlaceTitle" class="modal-title-place"></span>
        </div>
        <button type="button" class="modal-close-btn" aria-label="ë‹«ê¸°">&times;</button>
      </header>
      <div class="modal-body">
        <form id="ratingForm" class="rating-form">
          <div class="stars" data-rating="0">
            <span class="star" data-value="1">â˜…</span>
            <span class="star" data-value="2">â˜…</span>
            <span class="star" data-value="3">â˜…</span>
            <span class="star" data-value="4">â˜…</span>
            <span class="star" data-value="5">â˜…</span>
          </div>
          <input type="hidden" name="rating" id="ratingInput" value="0">
        </form>
      </div>
      <footer class="modal-actions">
        <button type="button" class="modal-btn modal-close-btn">ì·¨ì†Œ</button>
        <button type="button" id="submitRatingBtn" class="modal-btn primary" disabled>ì €ì¥</button>
      </footer>
    </div>
  </div>


  <script src="{{ url_for('static', filename='js/app.js') }}?v=4"></script>
  
  {% if kakao_js_key %}
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services"></script>
  {% endif %}

  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chatWindow = document.getElementById('chat-window');
      if (chatWindow.dataset.state !== 'ì™„ë£Œ' || window.resultsRendererInitialized) return;
      window.resultsRendererInitialized = true;

      window.handleImgError = function(e) {
        const img = e.target;
        const slide = img.closest('.carousel-slide') || img;
        const carousel = img.closest('.media-carousel-container');
        const slidesEl = carousel?.querySelector('.slides');
        if (!carousel || !slidesEl) return;

        slide.remove();

        const leftImgSlides = slidesEl.querySelectorAll('.carousel-slide[data-type="img"]').length;
        if (leftImgSlides === 0 && !slidesEl.querySelector('.noimage')) {
          const noimgSlide = document.createElement('div');
          noimgSlide.className = 'carousel-slide';
          noimgSlide.innerHTML = `<div class="noimage">ì´ë¯¸ì§€ ì—†ìŒ</div>`;
          slidesEl.insertBefore(noimgSlide, slidesEl.firstChild);
        }

        const cur = parseInt(carousel.dataset.slide || '0', 10);
        const total = slidesEl.querySelectorAll('.carousel-slide').length;
        updateCarouselState(carousel, Math.min(cur, Math.max(0, total - 1)));
      };

      async function fetchPlaceMedia(title, addr) {
        try {
          const res = await fetch(`/api/place-media?title=${encodeURIComponent(title)}&addr1=${encodeURIComponent(addr)}`);
          const data = await res.json();
          if (!data.ok) return { images: [], coords: null };
          return { images: data.images || [], coords: data.coords || null };
        } catch {
          return { images: [], coords: null };
        }
      }

      function updateCarouselState(carousel, newIndex) {
        const slidesEl = carousel.querySelector('.slides');
        const slides = slidesEl ? Array.from(slidesEl.querySelectorAll('.carousel-slide')) : [];
        const n = slides.length;
        if (!slidesEl || n === 0) return;

        const i = Math.max(0, Math.min(newIndex, n - 1));
        carousel.dataset.slide = String(i);
        slidesEl.style.transform = `translateX(-${i * 100}%)`;

        const prevBtn = carousel.querySelector('.cbtn.prev');
        const nextBtn = carousel.querySelector('.cbtn.next');
        if (prevBtn) prevBtn.hidden = (i <= 0);
        if (nextBtn) nextBtn.hidden = (i >= n - 1);
      }

      function setupCarousel(container, images, title, addr1) {
        const list = (images || []).filter(Boolean).slice(0, 4);
        const hasImages = list.length > 0;
        const canUploadMore = list.length < 4;

        const slideParts = [];

        if (!hasImages){
          slideParts.push(`<div class="carousel-slide"><div class="noimage">ì´ë¯¸ì§€ ì—†ìŒ</div></div>`);
        }

        for (const src of list){
          const proxied = src.startsWith('/uploads') ? src : `/img-proxy?u=${encodeURIComponent(src)}`;
          slideParts.push(`<div class="carousel-slide" data-type="img"><img src="${proxied}" alt="${title} ì´ë¯¸ì§€" loading="lazy" referrerpolicy="no-referrer" onerror="handleImgError(event)"></div>`);
        }

        if (canUploadMore){
          slideParts.push(`
            <div class="carousel-slide uploader-slide" data-type="uploader">
              <label class="image-uploader uploader-label" tabindex="0" aria-label="ì‚¬ì§„ ì˜¬ë¦¬ê¸° ë˜ëŠ” ì´¬ì˜">
                <div class="up-ic">ğŸ“·</div><div class="up-title">ì‚¬ì§„ ì˜¬ë¦¬ê¸° / ì´¬ì˜</div><div class="up-hint">ìµœëŒ€ 1ì¥ Â· 8MB</div>
                <input type="file" class="uploader-input" accept="image/*" capture="environment" />
              </label>
            </div>`);
        }

        const showNav = slideParts.length > 1;
        const nav = showNav ? `<button class="cbtn prev" type="button" aria-label="ì´ì „">â€¹</button><button class="cbtn next" type="button" aria-label="ë‹¤ìŒ">â€º</button>` : '';
        
        container.dataset.slide = '0';
        container.dataset.title = title;
        container.dataset.addr1 = addr1;
        container.innerHTML = `${nav}<div class="slides">${slideParts.join('')}</div>`;

        const fileInput = container.querySelector('.uploader-input');
        updateCarouselState(container, 0);

        async function doUpload(file){
          if (!file) return;
          
          const tlItem = container.closest('.tl-item');
          if (tlItem.classList.contains('upload-locked')) {
            alert('ì´ ì¥ì†Œì—ëŠ” ì´ë¯¸ ì‚¬ì§„ì„ ì˜¬ë¦¬ì…¨ì–´ìš”. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
          }

          try{
            const upSlide = container.querySelector('.uploader-slide');
            if (upSlide) upSlide.innerHTML = '<div class="image-uploader">ì—…ë¡œë“œ ì¤‘â€¦</div>';

            const fd = new FormData();
            fd.append('file', file);
            fd.append('title', title);
            fd.append('addr1', addr1);

            const res = await fetch('/api/upload-image', { method:'POST', body: fd });
            const json = await res.json();
            if (!json.ok) throw new Error(json.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');

            tlItem.classList.add('upload-locked');
            setupCarousel(container, json.images, title, addr1);
            
            const newImageIndex = json.images.length - (json.images.length < 4 ? 1 : 0);
            updateCarouselState(container, Math.max(0, newImageIndex - 1));

          } catch(err) {
            alert(err.message || 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            setupCarousel(container, images, title, addr1);
          }
        }

        if (fileInput) fileInput.addEventListener('change', (e)=> doUpload(e.target.files?.[0]));
        
        if (!container.dataset.listenerAttached) {
          container.dataset.listenerAttached = 'true';
          container.addEventListener('click', (e)=>{
            const prev = e.target.closest('.cbtn.prev');
            const next = e.target.closest('.cbtn.next');
            if (!prev && !next) return;
            
            const slidesEl = container.querySelector('.slides');
            if (!slidesEl) return;
            
            const slides = Array.from(slidesEl.querySelectorAll('.carousel-slide'));
            const cur = parseInt(container.dataset.slide || '0', 10);
            const lastIdx = slides.length - 1;
            
            if (prev){ 
              updateCarouselState(container, cur - 1);
            }
            if (next){ 
              const nextIdx = Math.min(cur + 1, lastIdx);
              updateCarouselState(container, nextIdx); 
            }
          });
        }
      }

      function setupMap(container, coords, title) {
        if (!window.kakao || !window.kakao.maps) {
          container.innerHTML = '<div class="no-map-placeholder">ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨</div>';
          return;
        }
        if (!coords || !coords.y || !coords.x) {
          container.innerHTML = '<div class="no-map-placeholder">ìœ„ì¹˜ ì •ë³´ ì—†ìŒ</div>';
          return;
        }
        container.innerHTML = '';
        const pos = new kakao.maps.LatLng(coords.y, coords.x);
        const map = new kakao.maps.Map(container, { center: pos, level: 4 });
        new kakao.maps.Marker({ map, position: pos });
        setTimeout(() => map.relayout(), 50);
      }

      async function updateMoveCardDetails(moveItem) {
        const fromAddr = moveItem.dataset.fromAddr;
        const toAddr = moveItem.dataset.toAddr;
        if (!fromAddr || !toAddr) return;

        const detailsEl = moveItem.querySelector('.move-details');
        if (!detailsEl) return;

        const formatStation = (line, station) => {
          if (!station) return '';
          if (line && station.includes(line)) return station;
          return line ? `${line} ${station}`.trim() : station;
        };

        try {
          const [fromRes, toRes] = await Promise.all([
            fetch(`/api/nearest-transit?addr=${encodeURIComponent(fromAddr)}`),
            fetch(`/api/nearest-transit?addr=${encodeURIComponent(toAddr)}`)
          ]);
          const fromData = await fromRes.json();
          const toData = await toRes.json();
          if (!fromData.ok || !toData.ok) return;

          const from = fromData.result, to = toData.result;
          let t1 = '', t2 = '';

          if (from.subway_station && to.subway_station && from.subway_station !== to.subway_station) {
            t1 = `ì§€í•˜ì²  ${formatStation(from.subway_line, from.subway_station)} ìŠ¹ì°¨`;
            t2 = `${formatStation(to.subway_line, to.subway_station)} í•˜ì°¨`;
          } else if (from.bus_station && to.bus_station && from.bus_station !== to.bus_station) {
            t1 = `ë²„ìŠ¤ ${from.bus_station} ìŠ¹ì°¨`;
            t2 = `${to.bus_station} í•˜ì°¨`;
          }

          if (t1) {
            detailsEl.innerHTML = `
              <span class="chip ghost small">${t1}</span>
              <span class="chip ghost small">${t2}</span>`;
          }
        } catch {}
      }
      
      const ratingModal = document.getElementById('ratingModal');
      const modalPlaceTitle = document.getElementById('modalPlaceTitle');
      const ratingFormStars = ratingModal.querySelector('.stars');
      const submitRatingBtn = document.getElementById('submitRatingBtn');
      let currentRatingTarget = null;

      function updateStarRatingUI(starDisplayElement, avgRating, totalRatings) {
        const avg = avgRating || 0;
        const total = totalRatings || 0;
        const inner = starDisplayElement.querySelector('.stars-inner');
        const avgEl = starDisplayElement.querySelector('.rating-avg');
        const countEl = starDisplayElement.querySelector('.rating-count');

        if (inner) inner.style.width = `${(avg / 5) * 100}%`;
        if (avgEl) avgEl.textContent = avg.toFixed(1);
        if (countEl) countEl.textContent = total;
      }

      function setStarsInModal(rating) {
        const stars = ratingFormStars.querySelectorAll('.star');
        stars.forEach(star => {
          star.classList.toggle('selected', star.dataset.value <= rating);
        });
        ratingFormStars.dataset.rating = rating;
        submitRatingBtn.disabled = rating == 0;
      }
      
      ratingFormStars.addEventListener('mouseover', e => {
        if (e.target.classList.contains('star')) {
          const rating = e.target.dataset.value;
          const stars = ratingFormStars.querySelectorAll('.star');
          stars.forEach(star => {
            star.classList.toggle('hover', star.dataset.value <= rating);
          });
        }
      });

      ratingFormStars.addEventListener('mouseout', () => {
        const currentRating = ratingFormStars.dataset.rating;
        setStarsInModal(currentRating);
      });
      
      ratingFormStars.addEventListener('click', e => {
        if (e.target.classList.contains('star')) {
          const rating = e.target.dataset.value;
          setStarsInModal(rating);
        }
      });
      
      function openRatingModal(targetCard) {
        currentRatingTarget = targetCard;
        const title = targetCard.dataset.title;
        modalPlaceTitle.textContent = title;
        
        fetchPlaceDetails(targetCard).then(data => {
            setStarsInModal(data.my_rating || 0);
        });

        ratingModal.classList.add('visible');
      }

      function closeRatingModal() {
        ratingModal.classList.remove('visible');
        currentRatingTarget = null;
        setStarsInModal(0);
      }
      
      ratingModal.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.addEventListener('click', closeRatingModal);
      });

      submitRatingBtn.addEventListener('click', async () => {
        if (!currentRatingTarget) return;

        const title = currentRatingTarget.dataset.title;
        const addr1 = currentRatingTarget.dataset.addr1;
        const rating = ratingFormStars.dataset.rating;

        try {
          const res = await fetch('/api/submit-review', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ title, addr1, rating }),
          });
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || 'ì €ì¥ ì‹¤íŒ¨');
          
          fetchPlaceDetails(currentRatingTarget, true);
          closeRatingModal();

        } catch (err) {
          alert(err.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        }
      });
      
      async function fetchPlaceDetails(cardElement, forceRefresh = false) {
        if (cardElement.dataset.detailsLoaded && !forceRefresh) {
            return JSON.parse(cardElement.dataset.detailsLoaded);
        }
        
        const title = cardElement.dataset.title;
        const addr1 = cardElement.dataset.addr1;
        const mapx = cardElement.dataset.mapx || '';
        const mapy = cardElement.dataset.mapy || '';

        const params = new URLSearchParams({ title, addr1, mapx, mapy });
        try {
            const res = await fetch(`/api/place-details?${params.toString()}`);
            const data = await res.json();
            if (!data.ok) throw new Error('ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
            
            cardElement.dataset.detailsLoaded = JSON.stringify(data);
            const starDisplay = cardElement.querySelector('.star-rating-display');
            if (starDisplay) {
                updateStarRatingUI(starDisplay, data.avg_rating, data.total_ratings);
            }
            return data;
        } catch (e) {
            console.error('ì¥ì†Œ ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', title, e);
            const starDisplay = cardElement.querySelector('.star-rating-display');
            if (starDisplay) updateStarRatingUI(starDisplay, 0, 0);
            return { kakao_url: null, avg_rating: 0, total_ratings: 0, my_rating: 0 };
        }
      }

      chatWindow.addEventListener('click', async e => {
        const starDisplay = e.target.closest('.star-rating-display');
        const reviewBtn = e.target.closest('.review-btn');
        const targetCard = e.target.closest('.tl-item.visit');

        if (!targetCard) return;

        if (starDisplay) {
          openRatingModal(targetCard);
        } else if (reviewBtn) {
          const details = await fetchPlaceDetails(targetCard);
          if (details.kakao_url) {
            window.open(details.kakao_url, '_blank');
          } else {
            if (confirm('ì´ ì¥ì†Œì— ëŒ€í•œ í›„ê¸° ì •ë³´ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ë³„ì ì„ ë‚¨ê¸°ì‹œê² ì–´ìš”?')) {
              openRatingModal(targetCard);
            }
          }
        }
      });

      async function initializeAllItems() {
        const allItems = document.querySelectorAll('li.tl-item');
        const visits = Array.from(document.querySelectorAll('li.tl-item.visit'));
        document.querySelectorAll('li.tl-item.move').forEach((moveNode, i) => {
          if (visits[i] && visits[i+1]) {
            moveNode.dataset.fromAddr = visits[i].dataset.addr1;
            moveNode.dataset.toAddr   = visits[i+1].dataset.addr1;
          }
        });

        for (const item of allItems) {
          if (item.classList.contains('visit')) {
            const title = item.dataset.title;
            const addr  = item.dataset.addr1;
            
            const carouselContainer = item.querySelector('.media-carousel-container');
            const mapContainer      = item.querySelector('.kakao-map-container');
            
            if (!carouselContainer || !mapContainer) continue;
            
            const { images, coords } = await fetchPlaceMedia(title, addr);
            
            setupCarousel(carouselContainer, images, title, addr);
            setupMap(mapContainer, coords, title);

            fetchPlaceDetails(item);

          } else if (item.classList.contains('move')) {
            const detailsEl = item.querySelector('.move-details');
            const textSpan  = detailsEl ? detailsEl.querySelector('span') : null;
            if (textSpan && (textSpan.textContent || '').includes('â†’')) {
              updateMoveCardDetails(item);
            }
          }
        }
      }

      if (window.kakao && window.kakao.maps) {
        kakao.maps.load(initializeAllItems);
      } else if (document.querySelector('.kakao-map-container')) {
        initializeAllItems();
      }
    });
  </script>
</body>
</html>