<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì±„ì±„</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2" />
</head>
<body>
  {% set state = session.get('state', 'ì§€ì—­') %}

  <header class="topbar">
    <div class="topbar-inner">
      <a class="home-btn" href="{{ url_for('home') }}" aria-label="í™ˆí˜ì´ì§€ë¡œ ê°€ê¸°">ğŸ  í™ˆí˜ì´ì§€</a>
      <a class="logo" href="{{ url_for('home') }}" aria-label="í™ˆìœ¼ë¡œ" title="í™ˆìœ¼ë¡œ" style="text-decoration:none;color:inherit">
        <span class="dot"></span>
        <strong>ì±„ì±„</strong>
      </a>
      <div class="topbar-actions">
        {% if state != 'ì§€ì—­' %}
          <a class="home-btn ghost" href="{{ url_for('go_back') }}">ë’¤ë¡œ ê°€ê¸°</a>
        {% endif %}
        <a class="home-btn" href="{{ url_for('reset_chat') }}">ìƒˆë¡œ ì‹œì‘</a>
      </div>
    </div>
  </header>

  <main class="chat-page">
    <section id="chat-window" class="chat-window" data-state="{{ state }}">
      <!-- Messages are dynamically loaded or rendered by Flask -->
      {% for msg in session.get('messages', []) %}
        <div class="msg {{ 'user' if msg['sender'] == 'user' else 'bot' }}">
          <div class="bubble">
            {% if msg.get('html') %}{{ msg['html']|safe }}{% else %}{{ msg['text'] }}{% endif %}
          </div>
        </div>
      {% endfor %}

      <!-- Renders input UI based on the current state -->
      {% if state == 'ì§€ì—­' %}
        <div class="msg bot"><div class="bubble">ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š<br /><b>ì–´ë–¤ ì§€ì—­</b>ìœ¼ë¡œ ì—¬í–‰ ê°€ì‹¤ ê±´ê°€ìš”?</div></div>
      {% elif state == 'ì ìˆ˜' %}
        <!-- Score selection UI -->
      {% elif state == 'í…Œë§ˆ' %}
        <!-- Theme selection UI -->
      {% elif state == 'ê¸°ê°„' %}
        <!-- Date range selection UI -->
      {% elif state == 'ì´ë™ìˆ˜ë‹¨' %}
        <!-- Transport mode selection UI -->
      {% elif state == 'ì™„ë£Œ' %}
        <div class="msg bot">
          <div class="bubble">
            <b>ì¶”ì²œ ì¼ì •ì´ ì¤€ë¹„ëì–´ìš”!</b> Day ì¹´ë“œë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤. âœ¨

            {% set itin = session.get('itinerary', []) %}
            {% if itin and itin|length > 0 %}
              {% set groups = (itin|groupby('day'))|list %}
              {% set cat_icons = {'ìì—°':'ğŸŒ³','ë ˆí¬ì¸ ':'ğŸƒ','ì‡¼í•‘':'ğŸ›ï¸','ìŒì‹':'ğŸ½ï¸','ì¸ë¬¸(ë¬¸í™”/ì˜ˆìˆ /ì—­ì‚¬)':'ğŸ›ï¸'} %}

              <div class="day-stack">
                {% for day, rows in groups %}
                  {% set rows = rows|list %}
                  {% set day_label = (rows[0].get('day_label') or (day ~ 'ì¼ì°¨')) %}
                  
                  <section class="day-card" data-day="{{ day }}" aria-label="{{ day_label }}">
                    <header class="day-card-header">
                      <div class="left"><span class="day-chip">{{ day_label }}</span></div>
                    </header>

                    <ol class="timeline">
                      {% for r in rows %}
                        {% set is_move = (r.get('title') == 'ì´ë™') %}
                        <li class="tl-item {{ 'move' if is_move else 'visit' }}"
                            {% if not is_move %}
                              data-title="{{ r.get('title') }}"
                              data-addr1="{{ r.get('addr1') }}"
                            {% endif %}>
                          
                          <div class="tl-content-wrapper">
                              <div class="tl-text-content">
                                <div class="tl-time">{{ r.get('start_time') }} â€“ {{ r.get('end_time') }}</div>
                                <!-- Text content for visit/move -->
                                {% if not is_move %}
                                  <h4 class="tl-title">
                                    <span class="ico">{{ cat_icons.get(r.get('cat1') or '', 'ğŸ“') }}</span>
                                    {{ r.get('title') }}
                                  </h4>
                                  <div class="tl-body">
                                    <div class="addr">{{ r.get('addr1') }}</div>
                                    <div class="tags">
                                      {% if r.get('cat1') %}<span class="chip">{{ r.get('cat1') }}</span>{% endif %}
                                      {% if r.get('cat3') %}<span class="chip ghost">{{ r.get('cat3') }}</span>{% endif %}
                                    </div>
                                  </div>
                                {% else %}
                                   <h4 class="tl-title">ğŸš‡ ì´ë™</h4>
                                {% endif %}
                              </div>

                              {% if not is_move %}
                              <div class="tl-media-content">
                                <div class="media-carousel-container">
                                  <div class="media-loading"><span>ğŸ“· ì´ë¯¸ì§€ ë¡œë”©ì¤‘...</span></div>
                                </div>
                                <div id="map-{{ day }}-{{ loop.index }}" class="kakao-map-container">
                                   <div class="media-loading"><span>ğŸ—ºï¸ ì§€ë„ ë¡œë”©ì¤‘...</span></div>
                                </div>
                              </div>
                              {% endif %}
                          </div>
                        </li>
                      {% endfor %}
                    </ol>
                  </section>
                {% endfor %}
              </div>
            {% else %}
              <div class="hint">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </section>

    {% if state == 'ì§€ì—­' %}
      <form class="input-bar" method="post" action="{{ url_for('chat') }}">
        <input class="chat-input" type="text" name="region" placeholder="ì˜ˆ) ì„œìš¸, ë¶€ì‚°, ì œì£¼â€¦" required autofocus />
        <button class="send-btn" type="submit" aria-label="ë³´ë‚´ê¸°">
          <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
        </button>
      </form>
    {% endif %}
  </main>

  <noscript>
    <div style="text-align:center; padding: 20px; color: #b91c1c;">
      ì´ í˜ì´ì§€ì˜ ì „ì²´ ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.
    </div>
  </noscript>

  <!-- Load step-by-step interaction logic -->
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>

  <!-- Kakao Maps SDK (only if key is provided) -->
  {% if kakao_js_key %}
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services"></script>
  {% endif %}

  <!-- Logic for rendering results (maps and images) -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Only run this script on the results page
    const chatWindow = document.getElementById('chat-window');
    if (chatWindow.dataset.state !== 'ì™„ë£Œ' || window.resultsRendererInitialized) {
      return;
    }
    window.resultsRendererInitialized = true;

    const DATA_CACHE = new Map();

    // Handles image loading errors
    window.handleImgError = function(e) {
      const img = e.target;
      const slide = img.closest('.carousel-slide');
      const carousel = img.closest('.carousel');
      if (!carousel || !slide) return;
      
      slide.remove(); // Remove the broken image slide
      
      const slides = carousel.querySelectorAll('.carousel-slide');
      if (slides.length === 0) {
        // If no images are left, show a placeholder
        const carouselContainer = carousel.closest('.media-carousel-container');
        if (carouselContainer) {
           carouselContainer.innerHTML = '<div class="no-image-placeholder">ì´ë¯¸ì§€ ì—†ìŒ</div>';
        }
        return;
      }
      
      carousel.dataset.count = slides.length;
      updateCarouselState(carousel, 0); // Reset to the first slide
    };

    // Fetches image URLs and geocoded coordinates for a place
    async function fetchPlaceData(title, addr) {
      const key = `${title}|${addr}`;
      if (DATA_CACHE.has(key)) return DATA_CACHE.get(key);

      try {
        // Fetch images and geocode data in parallel for speed
        const [imgRes, geoRes] = await Promise.all([
          fetch(`/api/places?title=${encodeURIComponent(title)}&addr1=${encodeURIComponent(addr)}`),
          fetch(`/api/geocode?title=${encodeURIComponent(title)}&addr=${encodeURIComponent(addr)}`)
        ]);

        const imgData = await imgRes.json();
        const geoData = await geoRes.json();

        const images = (imgData.ok && imgData.items.length > 0) ? imgData.items[0].images : [];
        const coords = (geoData.ok) ? geoData.result : null;

        const result = { images, coords };
        DATA_CACHE.set(key, result);
        return result;
      } catch (error) {
        console.error(`Data fetch failed for '${title}':`, error);
        return { images: [], coords: null };
      }
    }

    // Updates carousel UI (slide position, dots, arrows)
    function updateCarouselState(carousel, newIndex) {
        const slidesTrack = carousel.querySelector('.slides-track');
        const dots = carousel.querySelectorAll('.dots .dot');
        const prevBtn = carousel.querySelector('.cbtn.prev');
        const nextBtn = carousel.querySelector('.cbtn.next');
        const count = parseInt(carousel.dataset.count, 10) || 0;

        if (count === 0 || !slidesTrack) return;
        
        const index = Math.max(0, Math.min(newIndex, count - 1));

        carousel.dataset.slide = index;
        slidesTrack.style.transform = `translateX(-${index * 100}%)`;

        dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
        if (prevBtn) prevBtn.hidden = (index <= 0);
        if (nextBtn) nextBtn.hidden = (index >= count - 1);
    }
    
    // Creates and injects carousel HTML into the container
    function setupCarousel(container, images) {
        if (!images || images.length === 0) {
            container.innerHTML = '<div class="no-image-placeholder">ì´ë¯¸ì§€ ì—†ìŒ</div>';
            return;
        }

        const count = images.length;
        const slidesHtml = images.map(src => `
            <div class="carousel-slide">
                <img src="/img-proxy?u=${encodeURIComponent(src)}" alt="ì¥ì†Œ ì‚¬ì§„" loading="lazy" referrerpolicy="no-referrer" onerror="handleImgError(event)">
            </div>
        `).join('');

        const dotsHtml = count > 1 ? `<div class="dots">${Array.from({ length: count }, (_, i) => `<button type="button" class="dot" data-i="${i}"></button>`).join('')}</div>` : '';
        const buttonsHtml = count > 1 ? `
            <button class="cbtn prev" type="button" aria-label="ì´ì „">â€¹</button>
            <button class="cbtn next" type="button" aria-label="ë‹¤ìŒ">â€º</button>
        ` : '';

        container.innerHTML = `
            <div class="carousel" data-slide="0" data-count="${count}">
                ${buttonsHtml}
                <div class="slides-container"><div class="slides-track">${slidesHtml}</div></div>
                ${dotsHtml}
            </div>`;

        const carousel = container.querySelector('.carousel');
        updateCarouselState(carousel, 0);

        // Add event listeners for carousel controls
        carousel.addEventListener('click', (e) => {
            const target = e.target;
            let currentIndex = parseInt(carousel.dataset.slide || '0', 10);
            
            if (target.closest('.cbtn.next')) updateCarouselState(carousel, currentIndex + 1);
            else if (target.closest('.cbtn.prev')) updateCarouselState(carousel, currentIndex - 1);
            else if (target.matches('.dot')) updateCarouselState(carousel, parseInt(target.dataset.i, 10));
        });
    }

    // Creates and injects a Kakao Map into the container
    function setupMap(container, coords, title) {
        if (!window.kakao || !window.kakao.maps) {
          container.innerHTML = '<div class="no-map-placeholder">ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨</div>'; return;
        }
        if (!coords || !coords.y || !coords.x) {
            container.innerHTML = '<div class="no-map-placeholder">ìœ„ì¹˜ ì •ë³´ ì—†ìŒ</div>'; return;
        }
        
        container.innerHTML = ''; // Clear loading placeholder
        const position = new kakao.maps.LatLng(coords.y, coords.x);
        const map = new kakao.maps.Map(container, { center: position, level: 4 });
        const marker = new kakao.maps.Marker({ map: map, position: position });

        const infoWindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;font-size:12px;text-align:center;">${title}</div>`,
            removable: true
        });
        
        kakao.maps.event.addListener(marker, 'click', () => infoWindow.open(map, marker));
        
        // Ensure map resizes correctly within the flex container
        setTimeout(() => map.relayout(), 100);
    }
    
    // Main function to initialize all visit items on the page
    async function initializeAllVisitItems() {
        const visitItems = document.querySelectorAll('li.tl-item.visit');
        if (visitItems.length === 0) return;
        
        const promises = Array.from(visitItems).map(item => {
            const title = item.dataset.title;
            const addr = item.dataset.addr1;
            if (!title || !addr) return Promise.resolve(null);
            return fetchPlaceData(title, addr);
        });
        
        const results = await Promise.all(promises);

        visitItems.forEach((item, index) => {
            const data = results[index];
            if (!data) return;

            const carouselContainer = item.querySelector('.media-carousel-container');
            const mapContainer = item.querySelector('.kakao-map-container');
            const title = item.dataset.title;

            if (carouselContainer) setupCarousel(carouselContainer, data.images);
            if (mapContainer) setupMap(mapContainer, data.coords, title);
        });
    }

    // Execute after Kakao Maps SDK is fully loaded
    if (window.kakao && window.kakao.maps) {
        kakao.maps.load(initializeAllVisitItems);
    } else {
        // Fallback if the SDK script tag is missing or fails
        const mapContainers = document.querySelectorAll('.kakao-map-container');
        mapContainers.forEach(container => {
           container.innerHTML = '<div class="no-map-placeholder">ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨</div>';
        });
        // Still try to load images
        initializeAllVisitItems();
    }
  });
  </script>
</body>
</html>
