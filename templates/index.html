<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì±„ì±„</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>
<body>
  {% set state = session.get('state', 'ì§€ì—­') %}

  <!-- ìƒë‹¨ ë°” -->
  <header class="topbar">
    <div class="topbar-inner">
      <!-- ğŸ‘ˆ ì™¼ìª½ ìƒë‹¨: í™ˆí˜ì´ì§€ ë²„íŠ¼ -->
      <a class="home-btn" href="{{ url_for('home') }}" aria-label="í™ˆí˜ì´ì§€ë¡œ ê°€ê¸°">ğŸ  í™ˆí˜ì´ì§€</a>

      <!-- ë¡œê³ (ëˆŒëŸ¬ë„ í™ˆ ì´ë™) -->
      <a class="logo" href="{{ url_for('home') }}" aria-label="í™ˆìœ¼ë¡œ" title="í™ˆìœ¼ë¡œ"
         style="text-decoration:none;color:inherit">
        <span class="dot"></span>
        <strong>ì±„ì±„</strong>
      </a>

      <!-- ì˜¤ë¥¸ìª½ ì•¡ì…˜ë“¤ -->
      <div class="topbar-actions">
        {% if state != 'ì§€ì—­' %}
          <a class="home-btn ghost" href="{{ url_for('go_back') }}">ë’¤ë¡œ ê°€ê¸°</a>
        {% endif %}
        <a class="home-btn" href="{{ url_for('reset_chat') }}">ìƒˆë¡œ ì‹œì‘</a>
      </div>
    </div>
  </header>

  <main class="chat-page">
    <section id="chat-window" class="chat-window" data-state="{{ state }}">
      <!-- ê¸°ì¡´ ëŒ€í™” ë Œë” -->
      {% for msg in session.get('messages', []) %}
        <div class="msg {{ 'user' if msg['sender'] == 'user' else 'bot' }}">
          <div class="bubble">
            {% if msg.get('html') %}
              {{ msg['html']|safe }}
            {% else %}
              {{ msg['text'] }}
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <!-- â‘  ì§€ì—­ -->
      {% if state == 'ì§€ì—­' %}
        <div class="msg bot">
          <div class="bubble">
            ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š<br />
            <b>ì–´ë–¤ ì§€ì—­</b>ìœ¼ë¡œ ì—¬í–‰ ê°€ì‹¤ ê±´ê°€ìš”? ì•„ë˜ ì…ë ¥ì°½ì— ì§€ì—­ëª…ì„ ì ì–´ì£¼ì„¸ìš”.
          </div>
        </div>
      {% endif %}

      <!-- â‘¡ ì ìˆ˜ê¸°ì¤€ -->
      {% if state == 'ì ìˆ˜' %}
        <div class="msg bot">
          <div class="bubble">
            ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì²œí• ê¹Œìš”? <b>ê´€ê´‘ì§€ìˆ˜ vs ì¸ê¸°ë„ì§€ìˆ˜</b><br />í•˜ë‚˜ë§Œ ì„ íƒí•´ ì£¼ì„¸ìš”.
            <div class="pref-wrap">
              <button type="button" class="score-btn theme-btn" data-value="ê´€ê´‘ì§€ìˆ˜" aria-pressed="false">
                <span class="icon">ğŸ—ºï¸</span><span class="label">ê´€ê´‘ì§€ìˆ˜</span>
              </button>
              <button type="button" class="score-btn theme-btn" data-value="ì¸ê¸°ë„ì§€ìˆ˜" aria-pressed="false">
                <span class="icon">ğŸ”¥</span><span class="label">ì¸ê¸°ë„ì§€ìˆ˜</span>
              </button>
            </div>
            <form id="scoreForm" method="post" action="{{ url_for('chat') }}">
              <input type="hidden" name="score" id="scoreInput" />
            </form>
          </div>
        </div>
      {% endif %}

      <!-- â‘¢ í…Œë§ˆ -->
      {% if state == 'í…Œë§ˆ' %}
        {% set theme_icons = {'ìì—°':'ğŸŒ³','ë ˆí¬ì¸ ':'ğŸ„','ì‡¼í•‘':'ğŸ›ï¸','ìŒì‹':'ğŸ´','ì¸ë¬¸(ë¬¸í™”/ì˜ˆìˆ /ì—­ì‚¬)':'ğŸ“š'} %}
        {% set theme_items = [
          {'label':'ìì—°','value':'ìì—°'},
          {'label':'ë ˆí¬ì¸ ','value':'ë ˆí¬ì¸ '},
          {'label':'ì‡¼í•‘','value':'ì‡¼í•‘'},
          {'label':'ìŒì‹','value':'ìŒì‹'},
          {'label':'ë¬¸í™”','value':'ì¸ë¬¸(ë¬¸í™”/ì˜ˆìˆ /ì—­ì‚¬)'}
        ] %}
        <div class="msg bot">
          <div class="bubble">
            ì¢‹ì•„ìš”! ì´ì œ <b>ì›í•˜ëŠ” í…Œë§ˆë¥¼ ìµœëŒ€ 3ê°œ</b>ê¹Œì§€ ê³¨ë¼ì£¼ì„¸ìš”. (ë‹¤ì‹œ ëˆ„ë¥´ë©´ í•´ì œë¼ìš”)
            <div class="theme-wrap">
              {% for item in theme_items %}
                <button type="button" class="theme-btn" data-value="{{ item.value }}">
                  <span class="icon">{{ theme_icons[item.value] }}</span>
                  <span class="label">{{ item.label }}</span>
                </button>
              {% endfor %}
            </div>
            <div class="theme-actions">
              <button id="themeClear" type="button" class="ghost-btn small">ì„ íƒ ì´ˆê¸°í™”</button>
              <button id="themeSubmit" type="button" class="primary-btn small" disabled>ì„ íƒ ì™„ë£Œ (0/3)</button>
            </div>
            <form id="themeForm" method="post" action="{{ url_for('chat') }}">
              <input type="hidden" name="themes" id="themesInput" />
            </form>
          </div>
        </div>
      {% endif %}

      <!-- â‘£ ê¸°ê°„(ë‚ ì§œ ë²”ìœ„) -->
      {% if state == 'ê¸°ê°„' %}
        <div class="msg bot">
          <div class="bubble">
            <b>ì—¬í–‰ ê¸°ê°„</b>ì„ ì„ íƒí•´ ì£¼ì„¸ìš”. ì‹œì‘~ì¢…ë£Œ ë‚ ì§œë¥¼ ê³ ë¥´ë©´ <em>ì´ ì¼ìˆ˜</em>ê°€ ìë™ ê³„ì‚°ë¼ìš”.
            <form id="rangeForm" method="post" action="{{ url_for('chat') }}" class="range-form">
              <div class="date-row">
                <div class="date-box">
                  <label for="startDate">ì‹œì‘</label>
                  <div class="date-field">
                    <input id="startDate" class="date-input" type="date" name="start_date" aria-label="ì—¬í–‰ ì‹œì‘ì¼" />
                    <button id="openStart" class="date-btn" type="button" aria-label="ì‹œì‘ì¼ ë‹¬ë ¥ ì—´ê¸°" title="ë‹¬ë ¥ ì—´ê¸°">ğŸ“…</button>
                  </div>
                </div>

                <span class="date-tilde">~</span>

                <div class="date-box">
                  <label for="endDate">ì¢…ë£Œ</label>
                  <div class="date-field">
                    <input id="endDate" class="date-input" type="date" name="end_date" aria-label="ì—¬í–‰ ì¢…ë£Œì¼" />
                    <button id="openEnd" class="date-btn" type="button" aria-label="ì¢…ë£Œì¼ ë‹¬ë ¥ ì—´ê¸°" title="ë‹¬ë ¥ ì—´ê¸°">ğŸ“…</button>
                  </div>
                </div>

                <div class="days-pill"><span id="daysPreview">â€”</span></div>
                <button id="rangeSubmit" type="submit" class="primary-btn small" disabled>í™•ì¸</button>
              </div>
              <div class="hint mt-2">1~100ì¼ ì‚¬ì´ë§Œ ê°€ëŠ¥í•´ìš”.</div>
            </form>
          </div>
        </div>
      {% endif %}

      <!-- â‘¤ ì´ë™ìˆ˜ë‹¨ -->
      {% if state == 'ì´ë™ìˆ˜ë‹¨' %}
        <div class="msg bot">
          <div class="bubble">
            ë§ˆì§€ë§‰ìœ¼ë¡œ, <b>ì–´ë–¤ ì´ë™ìˆ˜ë‹¨</b>ìœ¼ë¡œ ë§ì¶œê¹Œìš”? (ê±·ê¸° vs ëŒ€ì¤‘êµí†µ)
            <div class="pref-wrap">
              <button type="button" class="transport-btn theme-btn" data-value="walk" aria-pressed="false">
                <span class="icon">ğŸš¶</span><span class="label">ê±·ê¸°</span>
              </button>
              <button type="button" class="transport-btn theme-btn" data-value="transit" aria-pressed="false">
                <span class="icon">ğŸš‹</span><span class="label">ëŒ€ì¤‘êµí†µ</span>
              </button>
            </div>
            <form id="transportForm" method="post" action="{{ url_for('chat') }}">
              <input type="hidden" name="transport" id="transportInput" />
            </form>
          </div>
        </div>
      {% endif %}

      <!-- â‘¥ ì™„ë£Œ (ì„¸ë¡œ ìŠ¤íƒ ì¹´ë“œ) -->
      {% if state == 'ì™„ë£Œ' %}
        <div class="msg bot">
          <div class="bubble">
            <b>ì¶”ì²œ ì¼ì •ì´ ì¤€ë¹„ëì–´ìš”!</b> Day ì¹´ë“œë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤. âœ¨

            {% set itin = session.get('itinerary', []) %}
            {% if itin and itin|length > 0 %}
              {% set groups = (itin|groupby('day'))|list %}
              {% set cat_icons = {'ìì—°':'ğŸŒ³','ë ˆí¬ì¸ ':'ğŸƒ','ì‡¼í•‘':'ğŸ›ï¸','ìŒì‹':'ğŸ½ï¸','ì¸ë¬¸(ë¬¸í™”/ì˜ˆìˆ /ì—­ì‚¬)':'ğŸ›ï¸'} %}

              <div class="day-stack">
                {% for day, rows in groups %}
                  {% set rows = rows|list %}
                  {% set raw_label = rows[0].get('day_label') or (day ~ 'ì¼') %}
                  {% set day_label = (raw_label|replace('ì¼ì°¨','')|replace('ì¼','')) ~ 'ì¼ì°¨' %}
                  {% set start_t = (rows|sort(attribute='start_time'))[0].start_time %}
                  {% set end_t = (rows|sort(attribute='end_time'))[-1].end_time %}

                  <section class="day-card" data-day="{{ day }}" aria-label="{{ day_label }}">
                    <header class="day-card-header">
                      <div class="left">
                        <span class="day-chip">{{ day_label }}</span>
                        <span class="day-range">{{ start_t }} ~ {{ end_t }}</span>
                        <span class="day-steps">{{ rows|length }} ìŠ¤í…</span>
                      </div>
                    </header>

                    <ol class="timeline">
                      {% for r in rows %}
                        {% set is_move = (r.get('title') == 'ì´ë™') %}
                        <li class="tl-item {{ 'move' if is_move else 'visit' }}">
                          <div class="tl-time">{{ r.get('start_time') }} â€“ {{ r.get('end_time') }}</div>

                          {% if is_move %}
                            <div class="tl-title">ğŸš‡ ì´ë™</div>
                            <div class="tl-body">
                              <div class="route">
                                <span class="chip sm">ì¶œë°œ</span>
                                <span class="text">{{ r.get('ì¶œë°œì§€') }}</span>
                              </div>
                              <div class="hint">
                                {% if r.get('êµí†µí¸1') %}<span class="chip sm">{{ r.get('êµí†µí¸1') }}</span>{% endif %}
                                {% if r.get('êµí†µí¸2') %}<span class="chip sm">{{ r.get('êµí†µí¸2') }}</span>{% endif %}
                              </div>
                              <div class="route">
                                <span class="chip sm">ë„ì°©</span>
                                <span class="text">{{ r.get('ë„ì°©ì§€') }}</span>
                              </div>
                            </div>
                            <div class="tl-meta">
                              {% if r.get('move_min') %}<span class="pill">ì´ë™ {{ r.get('move_min') }}ë¶„</span>{% endif %}
                              {% if r.get('distance_from_prev_km') %}<span class="pill">{{ r.get('distance_from_prev_km') }} km</span>{% endif %}
                            </div>
                          {% else %}
                            <div class="tl-title">
                              <span class="ico">{{ cat_icons.get(r.get('cat1') or '', 'ğŸ“') }}</span>
                              {{ r.get('title') }}
                            </div>
                            <div class="tl-body">
                              <div class="addr">{{ r.get('addr1') }}</div>
                              <div class="tags">
                                {% if r.get('cat1') %}<span class="chip">{{ r.get('cat1') }}</span>{% endif %}
                                {% if r.get('cat3') %}<span class="chip ghost">{{ r.get('cat3') }}</span>{% endif %}
                              </div>
                            </div>
                            <div class="tl-meta">
                              {% if r.get('move_min') and r.get('move_min') > 0 %}<span class="pill">ì´ë™ {{ r.get('move_min') }}ë¶„</span>{% endif %}
                              {% if r.get('stay_min') %}<span class="pill">ì²´ë¥˜ {{ r.get('stay_min') }}ë¶„</span>{% endif %}
                              {% if r.get('distance_from_prev_km') %}<span class="pill">{{ r.get('distance_from_prev_km') }} km</span>{% endif %}
                            </div>
                          {% endif %}
                        </li>
                      {% endfor %}
                    </ol>
                  </section>
                {% endfor %}
              </div>
            {% else %}
              <div class="hint">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}
          </div>
        </div>
      {% endif %}

      <!-- ì‹¤í–‰ì¤‘ ì˜¤ë²„ë ˆì´ -->
      {% if state == 'ì‹¤í–‰ì¤‘' %}
        <div class="chat-loading">
          <div class="spinner big"></div>
          <div class="hint mt-2">ì¼ì • ìƒì„± ì¤‘ì…ë‹ˆë‹¤â€¦</div>
        </div>
      {% endif %}
    </section>

    <!-- ì…ë ¥ ë°”: ì§€ì—­ ë‹¨ê³„ì—ì„œë§Œ ë…¸ì¶œ -->
    {% if state == 'ì§€ì—­' %}
      <form class="input-bar" method="post" action="{{ url_for('chat') }}">
        <input class="chat-input" type="text" name="region" placeholder="ì˜ˆ) ì„œìš¸, ë¶€ì‚°, ì œì£¼â€¦" required />
        <button class="send-btn" type="submit" aria-label="ë³´ë‚´ê¸°">
          <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
        </button>
      </form>
    {% endif %}
  </main>

  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
