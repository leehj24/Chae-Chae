<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>채채 – 추천 결과</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=14" />
</head>
<body>
  {% set state = session.get('state', '지역') %}

  <header class="topbar">
    <div class="topbar-inner">
      <a class="home-btn" href="{{ url_for('home') }}" aria-label="홈페이지로 가기">🏠 홈페이지</a>
      <a class="logo" href="{{ url_for('home') }}">
        <span class="dot"></span><strong>채채</strong>
      </a>
      <div class="topbar-actions">
        {% if session.get('messages', [])|length > 1 %}
          <a class="home-btn ghost" href="{{ url_for('go_back') }}">뒤로 가기</a>
        {% endif %}
        <a class="home-btn" href="{{ url_for('reset_chat') }}">새로 시작</a>
      </div>
    </div>
  </header>

  <main class="chat-page">
    <div class="chat-container">
      <section id="chat-window" class="chat-window" data-state="{{ state }}">
        {% for msg in session.get('messages', []) %}
          <div class="msg {{ 'user' if msg.sender == 'user' else 'bot' }}">
            <div class="bubble">
              {% if msg.html %}{{ msg.html|safe }}{% else %}{{ msg.text }}{% endif %}
            </div>
          </div>
        {% endfor %}

        {% if state == '완료' and session.get('itinerary') %}
          {% set itin = session.get('itinerary', []) %}
          {% set groups = (itin|groupby('day'))|list %}
          {% set cat_icons = {'자연':'🌳','레포츠':'🏃','쇼핑':'🛍️','음식':'🍽️','인문(문화/예술/역사)':'🏛️', '문화':'🎭'} %}
          <div class="day-stack">
            {% for day, rows in groups %}
              {% set rows = rows|list %}
              {% set day_label = (rows[0].get('day_label') or (day ~ '일차')) %}
              <section class="day-card" data-day="{{ day }}">
                <header class="day-card-header"><div class="day-chip">{{ day_label }}</div></header>
                <ol class="timeline">
                  {% for r in rows %}
                    {% set is_move = (r.title == '이동') %}
                    <li class="tl-item {{ 'move' if is_move else 'visit' }}"
                        {% if not is_move %}
                          data-title="{{ r.title }}"
                          data-addr1="{{ r.addr1 }}"
                          data-mapx="{{ r.get('mapx', '') }}"
                          data-mapy="{{ r.get('mapy', '') }}"
                          data-loaded="false"
                        {% endif %}>
                      <div class="tl-content-wrapper">
                        <div class="tl-text-content">
                          <div class="tl-time">{{ r.start_time }} – {{ r.end_time }}</div>
                          {% if not is_move %}
                            <h4 class="tl-title"><span class="ico">{{ cat_icons.get(r.cat1, '📍') }}</span>{{ r.title }}</h4>
                            <div class="addr">{{ r.addr1 }}</div>
                            <div class="tags">
                              {% if r.cat1 %}<span class="chip">{{ r.cat1 }}</span>{% endif %}
                              {% if r.cat3 %}<span class="chip ghost">{{ r.cat3 }}</span>{% endif %}
                            </div>
                            <div class="card-actions">
                              <div class="star-rating-display" role="button" tabindex="0">
                                <div class="stars-outer"><div class="stars-inner"></div></div>
                                <span class="rating-info"><span class="rating-avg">…</span> (<span class="rating-count">…</span>)</span>
                              </div>
                              <button type="button" class="review-btn">후기 보기/작성</button>
                            </div>
                          {% else %}
                            <h4 class="tl-title">🚇 이동</h4>
                            <div class="move-details">
                                <span class="chip ghost small">{{ r.교통편1 or (r.출발지 ~ ' → ' ~ r.도착지) }}</span>
                                {% if r.교통편2 %}<span class="chip ghost small">{{ r.교통편2 }}</span>{% endif %}
                            </div>
                          {% endif %}
                        </div>
                        {% if not is_move %}
                        <div class="tl-media-content">
                          <div class="media-carousel-container"><div class="media-loading"><div class="spinner small"></div></div></div>
                          <div class="kakao-map-container"><div class="media-loading"><div class="spinner small"></div></div></div>
                        </div>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ol>
              </section>
            {% endfor %}
          </div>
        {% endif %}
      </section>

      <div class="input-area">
        {% if state == '지역' %}
          <form class="input-bar" method="post" action="{{ url_for('chat') }}">
            <input class="chat-input" type="text" name="region" placeholder="예) 서울, 부산, 제주…" required autofocus />
            <button class="send-btn" type="submit" aria-label="보내기"><svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg></button>
          </form>
        {% elif state == '점수' %}
          <div class="button-wrap">
            <button type="button" class="score-btn theme-btn" data-value="관광지수"><span class="icon">🗺️</span><span class="label">관광지수</span></button>
            <button type="button" class="score-btn theme-btn" data-value="인기도지수"><span class="icon">🔥</span><span class="label">인기도지수</span></button>
          </div>
          <form id="scoreForm" method="post" action="{{ url_for('chat') }}"><input type="hidden" name="score" id="scoreInput" /></form>
        {% elif state == '테마' %}
          {% set themes = [{'v': '자연', 'l': '자연', 'i': '🌳'}, {'v': '레포츠', 'l': '레포츠', 'i': '🏃'}, {'v': '쇼핑', 'l': '쇼핑', 'i': '🛍️'}, {'v': '음식', 'l': '음식', 'i': '🍽️'}, {'v': '인문(문화/예술/역사)', 'l': '문화', 'i': '🎭'}] %}
          <div class="button-wrap wide">
            {% for t in themes %}<button type="button" class="theme-btn" data-value="{{ t.v }}"><span class="icon">{{ t.i }}</span><span class="label">{{ t.l }}</span></button>{% endfor %}
          </div>
          <div class="theme-actions">
            <button id="themeClear" type="button" class="ghost-btn small">초기화</button>
            <button id="themeSubmit" type="button" class="primary-btn small" disabled>선택 완료 (0/3)</button>
          </div>
          <form id="themeForm" method="post" action="{{ url_for('chat') }}"><input type="hidden" name="themes" id="themesInput" /></form>
        {% elif state == '기간' %}
          <form id="rangeForm" class="range-form" method="post" action="{{ url_for('chat') }}">
            <div class="date-row">
              <div class="date-box"><label for="startDate">시작</label><div class="date-field"><input id="startDate" name="start_date" type="date" /><button id="openStart" type="button">📅</button></div></div>
              <span class="date-tilde">~</span>
              <div class="date-box"><label for="endDate">종료</label><div class="date-field"><input id="endDate" name="end_date" type="date" /><button id="openEnd" type="button">📅</button></div></div>
            </div>
            <div class="range-actions">
              <div class="days-pill">총 <span id="daysPreview">—</span></div>
              <button id="rangeSubmit" type="submit" class="primary-btn small" disabled>확인</button>
            </div>
          </form>
        {% elif state == '이동수단' %}
          <div class="button-wrap">
            <button type="button" class="transport-btn theme-btn" data-value="walk"><span class="icon">🚶</span><span class="label">걷기</span></button>
            <button type="button" class="transport-btn theme-btn" data-value="transit"><span class="icon">🚋</span><span class="label">대중교통</span></button>
          </div>
          <form id="transportForm" method="post" action="{{ url_for('chat') }}"><input type="hidden" name="transport" id="transportInput" /></form>
        {% endif %}
      </div>
    </div>
  </main>

  <div id="ratingModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <header class="modal-header">
        <div>
          <h3 id="modalTitle">별점 남기기</h3>
          <span id="modalPlaceTitle" class="modal-title-place"></span>
        </div>
        <button type="button" class="modal-close-btn" aria-label="닫기">&times;</button>
      </header>
      <div class="modal-body">
        <form id="ratingForm" class="rating-form">
          <div class="stars" data-rating="0">
            <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
          </div>
        </form>
      </div>
      <footer class="modal-actions">
        <button type="button" class="modal-btn modal-close-btn">취소</button>
        <button type="button" id="submitRatingBtn" class="modal-btn primary" disabled>저장</button>
      </footer>
    </div>
  </div>

  <div id="reviewModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="reviewModalTitle">
    <div class="modal-content wide">
        <header class="modal-header">
            <div>
                <h3 id="reviewModalTitle">장소 후기</h3>
                <span id="reviewModalPlaceTitle" class="modal-title-place"></span>
            </div>
            <button type="button" class="modal-close-btn" aria-label="닫기">&times;</button>
        </header>
        <div class="review-content-container">
            <div id="reviewIframeContainer" class="review-container hidden"><iframe id="reviewIframe" src="about:blank" frameborder="0"></iframe></div>
            <div id="customReviewContainer" class="review-container hidden">
                <div class="review-modal-toolbar">
                    <div class="sort-dropdown" id="reviewSortDropdown" data-current="newest">
                        <button type="button" class="sort-trigger" aria-haspopup="listbox" aria-expanded="false"><span class="label">최신순</span><span class="chev" aria-hidden="true">▾</span></button>
                        <ul class="sort-menu" role="listbox">
                            <li role="option" data-value="newest" aria-selected="true">최신순</li>
                            <li role="option" data-value="oldest">오래된순</li>
                        </ul>
                    </div>
                    <button type="button" id="openWriteReviewBtn" class="primary-btn small">후기 작성</button>
                </div>
                <div id="reviewList" class="review-modal-body"></div>
            </div>
        </div>
    </div>
  </div>

  <div id="writeReviewModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="writeReviewModalTitle">
    <div class="modal-content">
        <header class="modal-header">
            <div>
                <h3 id="writeReviewModalTitle">후기 작성</h3>
                <span id="writeReviewModalPlaceTitle" class="modal-title-place"></span>
            </div>
            <button type="button" class="modal-close-btn" aria-label="닫기">&times;</button>
        </header>
        <div class="modal-body">
            <textarea id="reviewTextarea" class="review-textarea" placeholder="이 장소에 대한 경험을 공유해주세요. (10자 이상)" maxlength="500"></textarea>
        </div>
        <footer class="modal-actions">
            <button type="button" class="modal-btn modal-close-btn">취소</button>
            <button type="button" id="submitReviewBtn" class="modal-btn primary" disabled>완료</button>
        </footer>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/app.js') }}?v=5"></script>
  
  {% if kakao_js_key %}
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services"></script>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chatWindow = document.getElementById('chat-window');
      if (!chatWindow || chatWindow.dataset.state !== '완료' || window.resultsRendererInitialized) return;
      window.resultsRendererInitialized = true;

      let observer;

      window.handleImgError = function(e) {
        const img = e.target;
        const slide = img.closest('.carousel-slide') || img;
        const carousel = img.closest('.media-carousel-container');
        const slidesEl = carousel?.querySelector('.slides');
        if (!carousel || !slidesEl) return;
        slide.remove();
        const leftImgSlides = slidesEl.querySelectorAll('.carousel-slide[data-type="img"]').length;
        if (leftImgSlides === 0 && !slidesEl.querySelector('.noimage')) {
          const noimgSlide = document.createElement('div');
          noimgSlide.className = 'carousel-slide';
          noimgSlide.innerHTML = `<div class="noimage">이미지 없음</div>`;
          slidesEl.insertBefore(noimgSlide, slidesEl.firstChild);
        }
        const cur = parseInt(carousel.dataset.slide || '0', 10);
        const total = slidesEl.querySelectorAll('.carousel-slide').length;
        updateCarouselState(carousel, Math.min(cur, Math.max(0, total - 1)));
      };
      
      async function fetchPlaceMedia(title, addr) {
        try {
          const res = await fetch(`/api/place-media?title=${encodeURIComponent(title)}&addr1=${encodeURIComponent(addr)}`);
          const data = await res.json();
          if (!data.ok) return { images: [], coords: null };
          return { images: data.images || [], coords: data.coords || null };
        } catch {
          return { images: [], coords: null };
        }
      }

      function updateCarouselState(carousel, newIndex) {
        const slidesEl = carousel.querySelector('.slides');
        const slides = slidesEl ? Array.from(slidesEl.querySelectorAll('.carousel-slide')) : [];
        const n = slides.length;
        if (!slidesEl || n === 0) return;
        const i = Math.max(0, Math.min(newIndex, n - 1));
        carousel.dataset.slide = String(i);
        slidesEl.style.transform = `translateX(-${i * 100}%)`;
        const prevBtn = carousel.querySelector('.cbtn.prev');
        const nextBtn = carousel.querySelector('.cbtn.next');
        if (prevBtn) prevBtn.hidden = (i <= 0);
        if (nextBtn) nextBtn.hidden = (i >= n - 1);
      }
      
      function setupCarousel(container, images, title, addr1) {
        const list = (images || []).filter(Boolean).slice(0, 4);
        const hasImages = list.length > 0;
        const canUploadMore = list.length < 4;
        const slideParts = [];
        if (!hasImages){
          slideParts.push(`<div class="carousel-slide"><div class="noimage">이미지 없음</div></div>`);
        } else {
            for (const src of list){
            const proxied = src.startsWith('/uploads') ? src : `/img-proxy?u=${encodeURIComponent(src)}`;
            slideParts.push(`<div class="carousel-slide" data-type="img"><img src="${proxied}" alt="${title} 이미지" loading="lazy" referrerpolicy="no-referrer" onerror="handleImgError(event)"></div>`);
            }
        }
        if (canUploadMore){
          slideParts.push(`<div class="carousel-slide uploader-slide" data-type="uploader"><label class="image-uploader uploader-label" tabindex="0"><div class="up-ic">📷</div><div class="up-title">사진 올리기</div><input type="file" class="uploader-input" accept="image/*" /></label></div>`);
        }
        const showNav = slideParts.length > 1;
        const nav = showNav ? `<button class="cbtn prev" type="button" aria-label="이전">‹</button><button class="cbtn next" type="button" aria-label="다음">›</button>` : '';
        container.dataset.slide = '0';
        container.dataset.title = title;
        container.dataset.addr1 = addr1;
        container.innerHTML = `${nav}<div class="slides">${slideParts.join('')}</div>`;
        const fileInput = container.querySelector('.uploader-input');
        updateCarouselState(container, 0);
        
        async function doUpload(file){
            if (!file) return;
            const tlItem = container.closest('.tl-item');
            if (tlItem.classList.contains('upload-locked')) return;
            try{
                const upSlide = container.querySelector('.uploader-slide');
                if (upSlide) upSlide.innerHTML = '<div class="image-uploader">업로드 중…</div>';
                const fd = new FormData();
                fd.append('file', file); fd.append('title', title); fd.append('addr1', addr1);
                const res = await fetch('/api/upload-image', { method:'POST', body: fd });
                const json = await res.json();
                if (!json.ok) throw new Error(json.error || '업로드 실패');
                tlItem.classList.add('upload-locked');
                setupCarousel(container, json.images, title, addr1);
                updateCarouselState(container, json.images.length - (json.images.length < 4 ? 1 : 0) -1);
            } catch(err) {
                alert(err.message || '업로드 오류');
                setupCarousel(container, images, title, addr1);
            }
        }
        if (fileInput) fileInput.addEventListener('change', (e)=> doUpload(e.target.files?.[0]));
        
        if (!container.dataset.listenerAttached) {
            container.dataset.listenerAttached = 'true';
            container.addEventListener('click', (e)=>{
                const prev = e.target.closest('.cbtn.prev'), next = e.target.closest('.cbtn.next');
                if (!prev && !next) return;
                const cur = parseInt(container.dataset.slide || '0', 10);
                const lastIdx = container.querySelectorAll('.carousel-slide').length - 1;
                if (prev) updateCarouselState(container, cur - 1);
                if (next) updateCarouselState(container, Math.min(cur + 1, lastIdx));
            });
        }
      }

      function setupMap(container, coords, title) {
        if (!window.kakao || !window.kakao.maps) { container.innerHTML = '<div class="no-map-placeholder">지도 SDK 로드 실패</div>'; return; }
        if (!coords || !coords.y || !coords.x) { container.innerHTML = '<div class="no-map-placeholder">위치 정보 없음</div>'; return; }
        container.innerHTML = '';
        const pos = new kakao.maps.LatLng(coords.y, coords.x);
        const map = new kakao.maps.Map(container, { center: pos, level: 4, draggable: true, zoomable: true });
        new kakao.maps.Marker({ map, position: pos });
        setTimeout(() => map.relayout(), 50);
      }

      const ratingModal = document.getElementById('ratingModal');
      const reviewModal = document.getElementById('reviewModal');
      const writeReviewModal = document.getElementById('writeReviewModal');
      let currentReviewTarget = null;
      let currentReviews = [];

      async function fetchPlaceDetails(cardElement, forceRefresh = false) {
        if (cardElement.dataset.detailsLoaded && !forceRefresh) {
            return JSON.parse(cardElement.dataset.detailsLoaded);
        }
        const { title, addr1, mapx, mapy } = cardElement.dataset;
        const params = new URLSearchParams({ title, addr1, mapx: mapx || '', mapy: mapy || '' });
        try {
            const res = await fetch(`/api/place-details?${params.toString()}`);
            const data = await res.json();
            if (!data.ok) throw new Error('정보 로드 실패');
            cardElement.dataset.detailsLoaded = JSON.stringify(data);
            const starDisplay = cardElement.querySelector('.star-rating-display');
            if (starDisplay) {
                const avg = data.avg_rating || 0; const total = data.total_ratings || 0;
                starDisplay.querySelector('.stars-inner').style.width = `${(avg / 5) * 100}%`;
                starDisplay.querySelector('.rating-avg').textContent = avg.toFixed(1);
                starDisplay.querySelector('.rating-count').textContent = total;
            }
            return data;
        } catch (e) {
            console.error('장소 상세 정보 로드 실패:', title, e);
            const starDisplay = cardElement.querySelector('.star-rating-display');
            if (starDisplay) {
                starDisplay.querySelector('.stars-inner').style.width = '0%';
                starDisplay.querySelector('.rating-avg').textContent = '0.0';
                starDisplay.querySelector('.rating-count').textContent = '0';
            }
            return { kakao_url: null, avg_rating: 0, total_ratings: 0, my_rating: 0, my_review_text: null };
        }
      }

      function setupModals() {
          const ratingStars = ratingModal.querySelector('.stars');
          const submitRatingBtn = ratingModal.querySelector('#submitRatingBtn');
          const reviewList = reviewModal.querySelector('#reviewList');
          const reviewTextarea = writeReviewModal.querySelector('#reviewTextarea');
          const submitReviewTextBtn = writeReviewModal.querySelector('#submitReviewBtn');
          const reviewSortDropdown = document.getElementById('reviewSortDropdown');

          function setStarsInModal(rating = 0) {
              ratingStars.dataset.rating = rating;
              ratingStars.querySelectorAll('.star').forEach(s => s.classList.toggle('selected', s.dataset.value <= rating));
              submitRatingBtn.disabled = rating == 0;
          }
          ratingStars.addEventListener('mouseover', e => { if (e.target.classList.contains('star')) { const rating = e.target.dataset.value; ratingStars.querySelectorAll('.star').forEach(s => s.classList.toggle('hover', s.dataset.value <= rating)); } });
          ratingStars.addEventListener('mouseout', () => setStarsInModal(ratingStars.dataset.rating));
          ratingStars.addEventListener('click', e => { if (e.target.classList.contains('star')) setStarsInModal(e.target.dataset.value); });
          
          submitRatingBtn.addEventListener('click', async () => {
              if (!currentReviewTarget) return;
              const { title, addr1 } = currentReviewTarget.dataset;
              const rating = ratingStars.dataset.rating;
              try {
                  const res = await fetch('/api/submit-review', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, addr1, rating }) });
                  if (!res.ok) throw new Error('저장 실패');
                  fetchPlaceDetails(currentReviewTarget, true);
                  ratingModal.classList.remove('visible');
              } catch (err) { alert(err.message || '저장 중 오류 발생'); }
          });
          
          async function fetchAndRenderReviews() {
              if (!currentReviewTarget) return;
              reviewList.innerHTML = '<div class="media-loading"><div class="spinner small"></div></div>';
              const { title, addr1 } = currentReviewTarget.dataset;
              const res = await fetch(`/api/get-reviews?title=${encodeURIComponent(title)}&addr1=${encodeURIComponent(addr1)}`);
              const json = await res.json();
              currentReviews = json.ok ? (json.reviews || []) : [];
              renderReviewList();
          }

          function renderReviewList() {
              if (currentReviews.length === 0) {
                  reviewList.innerHTML = '<div class="review-empty">아직 후기가 없어요. 첫 후기를 남겨주세요!</div>';
                  return;
              }
              const sortOrder = reviewSortDropdown.dataset.current || 'newest';
              const sorted = [...currentReviews].sort((a,b) => sortOrder === 'newest' ? new Date(b.timestamp) - new Date(a.timestamp) : new Date(a.timestamp) - new Date(b.timestamp));
              reviewList.innerHTML = sorted.map(r => `<div class="review-card"><p class="review-card-text">${r.text.replace(/</g, "&lt;")}</p><div class="review-card-footer">${new Date(r.timestamp).toLocaleDateString()}</div></div>`).join('');
          }

          reviewTextarea.addEventListener('input', () => { submitReviewTextBtn.disabled = reviewTextarea.value.trim().length < 10; });
          
          submitReviewTextBtn.addEventListener('click', async () => {
              if (!currentReviewTarget) return;
              const { title, addr1 } = currentReviewTarget.dataset;
              const review_text = reviewTextarea.value.trim();
              try {
                  const res = await fetch('/api/submit-review', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, addr1, review_text }) });
                  if (!res.ok) throw new Error('저장 실패');
                  writeReviewModal.classList.remove('visible');
                  fetchAndRenderReviews();
              } catch(err) { alert(err.message || '저장 오류'); }
          });

          const reviewSortTrigger = reviewSortDropdown.querySelector('.sort-trigger');
          const reviewSortMenu = reviewSortDropdown.querySelector('.sort-menu');
          if(reviewSortTrigger && reviewSortMenu) {
            reviewSortTrigger.addEventListener('click', () => reviewSortDropdown.classList.toggle('open'));
            reviewSortMenu.querySelectorAll('[role="option"]').forEach(opt => {
                opt.addEventListener('click', () => {
                    reviewSortMenu.querySelector('[aria-selected="true"]').setAttribute('aria-selected', 'false');
                    opt.setAttribute('aria-selected', 'true');
                    reviewSortDropdown.dataset.current = opt.dataset.value;
                    reviewSortTrigger.querySelector('.label').textContent = opt.textContent;
                    reviewSortDropdown.classList.remove('open');
                    renderReviewList();
                });
            });
            document.addEventListener('click', e => { if (!reviewSortDropdown.contains(e.target)) reviewSortDropdown.classList.remove('open'); });
          }

          document.body.addEventListener('click', async (e) => {
              const ratingBtn = e.target.closest('.star-rating-display');
              const reviewBtn = e.target.closest('.review-btn');
              const openWriteBtn = e.target.closest('#openWriteReviewBtn');
              const closeModalBtn = e.target.closest('.modal-close-btn');
              
              if (ratingBtn) {
                  currentReviewTarget = ratingBtn.closest('.tl-item.visit');
                  ratingModal.querySelector('#modalPlaceTitle').textContent = currentReviewTarget.dataset.title;
                  const details = await fetchPlaceDetails(currentReviewTarget);
                  setStarsInModal(details.my_rating);
                  ratingModal.classList.add('visible');
              }
              if (reviewBtn) {
                  currentReviewTarget = reviewBtn.closest('.tl-item.visit');
                  reviewModal.querySelector('#reviewModalPlaceTitle').textContent = currentReviewTarget.dataset.title;
                  const details = await fetchPlaceDetails(currentReviewTarget);
                  if (details.kakao_url) {
                      reviewModal.querySelector('#reviewIframe').src = details.kakao_url;
                      reviewModal.querySelector('#reviewIframeContainer').classList.remove('hidden');
                      reviewModal.querySelector('#customReviewContainer').classList.add('hidden');
                  } else {
                      reviewModal.querySelector('#reviewIframeContainer').classList.add('hidden');
                      reviewModal.querySelector('#customReviewContainer').classList.remove('hidden');
                      fetchAndRenderReviews();
                  }
                  reviewModal.classList.add('visible');
              }
              if (openWriteBtn) {
                  const details = await fetchPlaceDetails(currentReviewTarget);
                  writeReviewModal.querySelector('#writeReviewModalPlaceTitle').textContent = currentReviewTarget.dataset.title;
                  reviewTextarea.value = details.my_review_text || '';
                  submitReviewTextBtn.disabled = reviewTextarea.value.trim().length < 10;
                  writeReviewModal.classList.add('visible');
              }
              if (closeModalBtn) {
                  closeModalBtn.closest('.modal-backdrop').classList.remove('visible');
              }
          });
      }

      function initializeAllItems() {
        const allVisitItems = document.querySelectorAll('li.tl-item.visit');
        
        if (observer) observer.disconnect();

        const observerCallback = (entries, obs) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const item = entry.target;
              if (item.dataset.loaded === 'true') {
                  obs.unobserve(item);
                  return;
              }
              item.dataset.loaded = 'true';
              
              const { title, addr1 } = item.dataset;
              const carouselContainer = item.querySelector('.media-carousel-container');
              const mapContainer = item.querySelector('.kakao-map-container');
              
              if (carouselContainer && mapContainer) {
                fetchPlaceMedia(title, addr1).then(({ images, coords }) => {
                  setupCarousel(carouselContainer, images, title, addr1);
                  setupMap(mapContainer, coords, title);
                });
              }
              fetchPlaceDetails(item);
              
              obs.unobserve(item);
            }
          });
        };

        observer = new IntersectionObserver(observerCallback, {
            rootMargin: '0px 0px 300px 0px',
            threshold: 0.01
        });

        allVisitItems.forEach(item => {
            observer.observe(item);
        });
      }

      setupModals();
      
      if (window.kakao && window.kakao.maps) {
        kakao.maps.load(initializeAllItems);
      } else {
        initializeAllItems();
      }
    });
  </script>
</body>
</html>